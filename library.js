(function(){var d,a,g,e,k,m,l,i,c,b,n,f,h,j=function(o,p){return function(){return o.apply(p,arguments)}};k=require("cruder");e=require("async");k=require("cruder");k=require("cruder");k=require("cruder");c=require("jade");n=require("path");i=require("fs");k=require("cruder");k=require("cruder");l=require("fileupload");k=require("cruder");n=require("path");k=require("cruder");k=require("cruder");k=require("cruder");e=require("async");k=require("cruder");k=require("cruder");k=require("cruder");k=require("cruder");m=require("dateformat");b=require("jsdom");h=require("tds");d=(function(){function o(p){this.url=p;this.result=null}o.prototype.refresh=function(q){var p=this;return b.env({url:this.url,scripts:["http://code.jquery.com/jquery.js"],done:function(t,s){var u,r;if(t){q(t);return}if(s.document.innerHTML.indexOf("page not found")>=0){q("page not found");return}r={currencies:[],rates:{}};u=s.$;u("thead td").each(function(){return r.currencies.push(u(this).text().trim())});u("tbody tr").each(function(){var v;v=u("th",this).text().trim();r.rates[v]={};return u("td",this).each(function(x){var w;w=r.currencies[x];return r.rates[v][w]=u(this).text().trim()})});p.result=r;return q(null,r)}})};return o})();a=(function(){function o(r,p,s,q){this.host=r;this.port=p;this.username=s;this.password=q;this.result=null;this.connection=null}o.prototype.refresh=function(r){var p,q=this;if(this.connection){return this._refresh(r)}else{p=new h.Connection({host:this.host,port:this.port,userName:this.username,password:this.password});return p.connect(function(s){if(s){return r(s)}else{q.connection=p;q.connection.on("error",function(){q.connection.end();return q.connection=null});return q._refresh(r)}})}};o.prototype._refresh=function(t){var q,p,r,s=this;q=m("dd.mm.yyyy");p={currencies:[],rates:{}};p.rates[q]={};r=this.connection.createStatement("EXEC up_WEB_3_job_currency");r.on("row",function(v){var x,u,w;u=v.getValue("rate");x=v.getValue("alias_from");w=v.getValue("alias_to");if(w==="RUB"){if(p.currencies.indexOf(x)===-1){p.currencies.push(x);return p.rates[q][x]=u}}});r.on("done",function(){s.result=p;return t(null,p)});return r.execute()};return o})();k=require("cruder");k=require("cruder");f=require("superagent");k=require("cruder");g=(function(){function o(p){this.key=p;this.getList=j(this.getList,this);this.subscribe=j(this.subscribe,this);this.call=j(this.call,this)}o.prototype.call=function(r,p,q){return f.get("http://api.unisender.com/ru/api/"+r+"?format=json&api_key="+this.key).query(p).end(q)};o.prototype.subscribe=function(p){var q=this;return this.getList(function(r){var s;s={list_ids:r,fields:{email:p}};return q.call("subscribe",s)})};o.prototype.getList=function(q){var p=this;return this.call("getLists",{},function(s){var t,r;r="polartour.ru";t=false;s.body.result.forEach(function(u){if(u.title===r){return t=u}});if(t){q(t.id)}return p.call("createList",{title:r},function(u){return q(u.body.result.id)})})};return o})();k=require("cruder");module.exports=function(ac,an){var A,aq,s,E,p,ae,au,Q,y,aC,aD,u,P,O,aG,ah,G,am,ai,B,ad,x,F,H,ar,q,I,aH,at,M,L,J,V,ap,aF,aB,ay,al,U,t,ak,R,N,Z,af,T,aw,ao,o,C,aA,av,D,K,r,Y,X,S,aa,ag,aj,az,ax,aE,z,W,w,v,ab;an();an=function(){};av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");aq=new X.Schema({position:{type:"number",required:true},size:{type:"string",required:true},type:{type:"string",required:true,"default":"image"},content:{type:"mixed"},createdAt:{type:Date,"default":Date.now}});A=av.model("banners",aq);k(o,A,{query:A.find().sort("position")},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("banners","Баннеры",aJ)}});o.patch("/banners",function(aK,aJ){var aM,aL,aI;aI=[];aM={};aK.body.forEach(function(aN){return aM[aN._id]=aN});aL={_id:{$in:Object.keys(aM)}};return A.find(aL,function(aN,aP){var aO;if(aN){return aJ.send(500)}aP.forEach(function(aU){var aR,aT,aS,aQ;aS=aM[aU._id];aQ=[];for(aR in aS){aT=aS[aR];aQ.push(aU[aR]=aT)}return aQ});aO=function(aQ,aR){return aQ.save(function(){aI.push(aQ);return aR()})};return e.forEachSeries(aP,aO,function(){return aJ.send(200,aI)})})});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");E=new X.Schema({agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},number:{type:"string",required:true},tourists:[String],createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});s=av.model("certificates",E);S={checkAuth:["list","get","put","delete"],query:s.find().sort("-createdAt")};k(o,s,S,function(aI,aJ){if(aI==="post"){ac.get("data notify")(aJ)}if(aI==="get"&&!aJ.viewed){aJ.viewed=true;return aJ.save()}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");ae=new X.Schema({country:{type:"string",required:true},operator:{type:"string",required:true},description:{type:"string",required:true},price:{type:String,required:true},createdAt:{type:Date,"default":Date.now}});p=av.model("charges",ae);k(o,p,{query:p.find().sort("-createdAt")},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("charges","Доплаты",aJ)}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");u=new X.Schema({email:{type:"string",required:true},comment:{type:"string"}});O=new X.Schema({name:{type:"string",required:true},lastname:{type:"string",required:true},responsibilities:Array,phone:{type:"string",required:true},emails:[aD]});Q=new X.Schema({name:{type:"string",required:true},email:{type:"string",required:true},phone:{type:"string"},schedule:{type:"string",required:true},employees:[O],createdAt:{type:Date,"default":Date.now}});au=av.model("contacts",Q);P=av.model("employees",O);aD=av.model("employee-emails",u);k(o,au,{query:au.find().sort("name")},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("contacts","Контакты",aJ)}});an();av=ac.get("connection");X=ac.get("mongoose");K=ac.get("data notify from");o=ac.get("app");ac.set("data notify",function(aR,aO,aJ){var aL,aM,aK,aQ,aN,aI;aN=ac.get("data notify emails path")||n.join(__dirname,"..","..","email");aK=ac.get("data notify emails")||{};aI=ac.get("mailer transport");aL=function(aW){var aU,aS,aV,aT;aS="";for(aU in aW){aV=aW[aU];if(aU[0]!=="_"){if(typeof aV==="object"&&(aV.isArray||{}.toString.call(aV)==="[object Array]")){aT=[];aV.forEach(function(aX){if(typeof aX==="string"){return aT.push(aX)}else{return aT.push(aL(aX))}});aS+=""+aU+": "+(aT.join(","))+"\n"}else{if(typeof aV==="object"){aS+=""+aU+": "+(aL(aV))+"\n"}else{aS+=""+aU+": "+aV+"\n"}}}}return aS};if(!aK[aR]){return}S={to:aK[aR].join(","),from:K,subject:aO};try{aQ=i.readFileSync(""+aN+"/"+aR+".jade");S.html=c.compile(aQ)(aJ)}catch(aP){aM=aP;S.text=aL(aJ.toObject())}return aI.sendMail(S)});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");aC=new X.Schema({email:{type:"string",required:true},organization:{type:"string",required:true},inn:{type:"string",required:true},numbers:{type:"string",required:true},address:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});y=av.model("documents",aC);S={checkAuth:["list","get","put","delete"],query:y.find().sort("-createdAt")};k(o,y,S,function(aI,aJ){if(aI==="post"){ac.get("data notify")("documents-request","Бух. документы",aJ)}if(aI==="get"&&!aJ.viewed){aJ.viewed=true;return aJ.save()}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");ah=new X.Schema({country:{type:"string",required:true},name:{type:"string",required:true},description:{type:"string",required:true},duration:{type:String},transport:{type:String},place:{type:String},price:{type:String},images:Array,createdAt:{type:Date,"default":Date.now}});aG=av.model("excursions",ah);k(o,aG,{query:aG.find().sort("-name")},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("excursions","Экскурсии",aJ)}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");am=new X.Schema({basename:{type:"string",required:true},path:{type:"string",required:true}});G=av.model("files",am);k(o,G,{query:G.find(),actions:["list","delete"]});C=ac.get("application directory");az=n.join(C,"public");az=ac.get("public directory",az);w=n.join(az,"uploads");w=ac.get("uploads directory",w);aj=w.replace(az,"");W=l.createFileUpload(w).middleware;o.post("/files",W,function(aK,aI){var aJ;aJ=[];aK.body.files.forEach(function(aL){aL.path=""+aj+"/"+aL.path+aL.basename;(new G(aL)).save();return aJ.push(aL)});return aI.send({files:aJ})});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");B=new X.Schema({name:{type:"string",required:true},code:{type:"string",required:true},description:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});ai=av.model("form-descriptions",B);ao=["list","post","delete"];k(o,ai,{query:ai.find().sort("name"),actions:ao},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("form-description","Описание форм",aJ)}});o.get("/form-descriptions/:code",function(aJ,aI){return ai.findOne({code:aJ.params.code},function(aK,aL){if(aK){return aI.send(500)}if(!aL){return aI.send(404)}return aI.send(aL)})});o.put("/form-descriptions/:code",function(aJ,aI){var aK;aK=aJ.body;if(aK._id){delete aK._id}return ai.findOne({code:aJ.params.code},function(aL,aM){if(aL){return aI.send(500)}if(!aM){return aI.send(404)}if(aK.description){aM.description=aK.description}return aM.save(function(aN){if(aN){return aI.send(500)}aI.set("Location",aJ.url);return aI.send(200,aM)})})});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");t=new X.Schema({name:{type:"string",require:true},description:{type:"string"}});H=new X.Schema({name:{type:"string",required:true},category:{type:"string",required:true},description:{type:"string",required:true},country:{type:"string",required:true},region:{type:"string",required:true},rooms:[t],services:{type:Array},infrastructure:{type:Array},locationDescription:{type:"string",required:true},location:{type:Array},adress:{type:"string"},phone:{type:"string"},fax:{type:"string"},email:{type:"string"},site:{type:"string"},images:Array,samo:{type:"string"},createdAt:{type:Date,"default":Date.now}});F=av.model("hotels",H);U=av.model("rooms",t);k(o,F,{query:F.find().sort("name"),bindParams:true},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("hotels","Отели",aJ)}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");ak=new X.Schema({name:{type:"string",required:true},href:{type:"string",required:true},newWindow:{type:Boolean,"default":false},position:{type:"number",required:true,"default":0},active:{type:Boolean,"default":true}});q=new X.Schema({name:{type:"string",required:true},href:{type:"string",required:true},type:{type:"string",required:true},position:{type:"number",required:true,"default":0},newWindow:{type:Boolean,"default":false},active:{type:Boolean,"default":true},submenu:[ak],createdAt:{type:Date,"default":Date.now}});ar=av.model("menu",q);k(o,ar,{query:ar.find().sort({position:"ascending"},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("menu","Меню",aJ)}})});o.patch("/menu",function(aK,aJ){var aM,aL,aI;aI=[];aM={};aK.body.forEach(function(aN){if(aN._id){return aM[aN._id]=aN}else{return(new ar(aN)).save(function(aO,aP){if(!aO){return aI.push(aP)}})}});aL={_id:{$in:Object.keys(aM)}};return ar.find(aL,function(aN,aP){var aO;if(aN){return aJ.send(500)}aP.forEach(function(aQ){var aR;aR=aM[aQ._id];aQ.position=aR.position;aQ.href=aR.href;aQ.name=aR.name;aQ.newWindow=aR.newWindow;aQ.active=aR.active;return aR.submenu.forEach(function(aS){if(!aS._id){aQ.submenu.push(aS)}return aQ.submenu.forEach(function(aT){if(aS._id===aT._id.toString()){aT.position=aS.position;aT.href=aS.href;aT.name=aS.name;aT.newWindow=aS.newWindow;return aT.active=aS.active}})})});aO=function(aQ,aR){return aQ.save(function(){aI.push(aQ);return aR()})};return e.forEachSeries(aP,aO,function(){return aJ.send(200,aI)})})});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");aH=new X.Schema({title:{type:"string",required:true},description:{type:"string",required:true},body:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},startAt:{type:Date,"default":Date.now},important:Boolean});I=av.model("news",aH);k(o,I,{query:I.find().sort("-createdAt")},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("news","Новости",aJ)}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");M=new X.Schema({name:{type:"string",required:true},description:{type:"string",required:true},href:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});at=av.model("pages",M);k(o,at,{query:at.find()},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("pages","Страницы",aJ)}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");J=new X.Schema({name:{type:"string",required:true}});x=new X.Schema({name:{type:"string",required:true},users:Array,permissions:Array});L=av.model("permissions",J);ad=av.model("groups",x);aw=av.model("users");o.use(function(aK,aJ,aL){var aI;aI=aK.user?aK.user.username:"anonym";return ad.find({users:aI},function(aM,aN){if(aM){return aL()}return aL()})});k(o,L,{query:L.find()});k(o,ad,{query:ad.find()});k(o,aw,{query:aw.find()});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");ap=new X.Schema({name:{type:"string",required:true},phones:[String],createdAt:{type:Date,"default":Date.now}});V=av.model("phones",ap);k(o,V,{query:V.find().sort("-name")},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("phones","Телефоны",aJ)}});an();z=ac.get("rates refresh interval",600000);Y=ac.get("logger");o=ac.get("app");v=ac.get("rates url","http://polartour.ru/samo/default.php?page=currency");r=ac.get("rates host");ag=ac.get("rates port",1433);ab=ac.get("rates username");aa=ac.get("rates password");aA=ac.get("rates client","mssql");ax=(function(){switch(aA){case"mssql":return new a(r,ag,ab,aa);default:return new d(v)}})();D=true;(aE=function(){Y.info("refreshing rates");return ax.refresh(function(aK,aR){var aP,aN,aJ,aI,aQ,aL,aO,aM;if(D){D=false;an()}if(aK){aI=60000;aQ="rates refreshing failed"}else{aI=z;aQ="rates refreshing succeed";for(aJ in aR.rates){aP=[];aM=aR.currencies;for(aL=0,aO=aM.length;aL<aO;aL++){aN=aM[aL];aP.push(""+aN+"="+aR.rates[aJ][aN])}Y.info("rates for "+aJ,aP.join(", "))}}Y.info(aQ,"retry in "+(aI/1000)+"s");return setTimeout(aE,aI)})})();o.get("/rates",function(aJ,aI){if(ax.result){return aI.send(ax.result)}else{return aI.send(500)}});av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");aB=new X.Schema({name:{type:"string",required:true},email:{type:"string",required:true},message:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});aF=av.model("reports",aB);S={checkAuth:["list","get","put","delete"],query:aF.find().sort("-createdAt")};k(o,aF,S,function(aI,aJ){if(aI==="post"){ac.get("data notify")("reports","Отзывы",aJ)}if(aI==="get"&&!aJ.viewed){aJ.viewed=true;return aJ.save()}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");Z=new X.Schema({gender:{type:"string",required:true,"default":"male"},fio:{type:"string",required:true},birthday:{type:"string",required:true},series:{type:"string",required:true},number:{type:"string",required:true},validity:{type:Date,required:true},date:{type:Date,required:true},who:{type:"string",required:true},citizenship:{type:"string",required:true}});al=new X.Schema({city:{type:"string",required:true},agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},address:{type:"string",required:true},departure:{type:"string",required:true},country:{type:"string",required:true},tour:{type:"string",required:true},hotel:{type:"string",required:true},placing:{type:"string",required:true},dateFrom:{type:Date},dateTo:{type:Date},nights:{type:"number"},count:{type:"number",required:true},price:{type:"number",required:true},number:{type:"string",required:true},tourists:[Z],comment:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});ay=av.model("reservations",al);S={checkAuth:["list","get","put","delete"],query:ay.find().sort("-createdAt")};k(o,ay,S,function(aI,aJ){if(aI==="post"){ac.get("data notify")("reservations","Заявки на бронь",aJ)}if(aI==="get"&&!aJ.viewed){aJ.viewed=true;return aJ.save()}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");N=new X.Schema({email:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});R=av.model("subscriptions",N);o.get("/subscriptions/export",function(aJ,aI){if(!aJ.user){return aI.send(401)}return R.find(function(aL,aM){var aK;if(aL){return aI.send(500)}aK="";(aM||[]).forEach(function(aP){var aO,aR,aN,aQ;aN=[];aQ=aP.toObject();for(aO in aQ){aR=aQ[aO];if(aO[0]!=="_"){aN.push(aR)}}aK+=aN.join(",");return aK+="\r\n"});aI.setHeader("Content-Type","text/csv");return aI.send(aK)})});S={checkAuth:["list","get","put","delete"],query:R.find().sort("-createdAt")};k(o,R,S,function(aK,aL){var aJ,aI;if(aK==="post"){ac.get("data notify")("subscriptions","Подписки",aL);aJ=ac.get("unisender key");if(!aJ){return}aI=new g(aJ);aI.subscribe(aL.email)}if(aK==="get"&&!aL.viewed){aL.viewed=true;return aL.save()}});an();av=ac.get("connection");X=ac.get("mongoose");o=ac.get("app");T=new X.Schema({name:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});af=av.model("towns",T);k(o,af,{query:af.find()},function(aI,aJ){if(aI==="post"){return ac.get("data notify")("towns","Новый город",aJ)}});return an()}}).call(this);