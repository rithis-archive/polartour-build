(function(){var d,a,g,e,k,l,i,c,b,m,f,h,j=function(n,o){return function(){return n.apply(o,arguments)}};k=require("cruder");e=require("async");k=require("cruder");k=require("cruder");k=require("cruder");c=require("jade");m=require("path");i=require("fs");k=require("cruder");k=require("cruder");k=require("cruder");k=require("cruder");k=require("cruder");e=require("async");k=require("cruder");k=require("cruder");k=require("cruder");k=require("cruder");l=require("dateformat");b=require("jsdom");h=require("tds");d=(function(){function n(o){this.url=o;this.result=null}n.prototype.refresh=function(p){var o=this;return b.env({url:this.url,scripts:["http://code.jquery.com/jquery.js"],done:function(s,r){var t,q;if(s){p(s);return}if(r.document.innerHTML.indexOf("page not found")>=0){p("page not found");return}q={currencies:[],rates:{}};t=r.$;t("thead td").each(function(){return q.currencies.push(t(this).text().trim())});t("tbody tr").each(function(){var u;u=t("th",this).text().trim();q.rates[u]={};return t("td",this).each(function(w){var v;v=q.currencies[w];return q.rates[u][v]=t(this).text().trim()})});o.result=q;return p(null,q)}})};return n})();a=(function(){function n(q,o,r,p){this.host=q;this.port=o;this.username=r;this.password=p;this.result=null;this.connection=null}n.prototype.refresh=function(q){var o,p=this;if(this.connection){return this._refresh(q)}else{o=new h.Connection({host:this.host,port:this.port,userName:this.username,password:this.password});return o.connect(function(r){if(r){return q(r)}else{p.connection=o;p.connection.on("error",function(){p.connection.end();return p.connection=null});return p._refresh(q)}})}};n.prototype._refresh=function(s){var p,o,q,r=this;p=l("dd.mm.yyyy");o={currencies:[],rates:{}};o.rates[p]={};q=this.connection.createStatement("EXEC up_WEB_3_job_currency");q.on("row",function(u){var w,t,v;t=u.getValue("rate");w=u.getValue("alias_from");v=u.getValue("alias_to");if(v==="RUB"){if(o.currencies.indexOf(w)===-1){o.currencies.push(w);return o.rates[p][w]=t}}});q.on("done",function(){r.result=o;return s(null,o)});return q.execute()};return n})();k=require("cruder");k=require("cruder");f=require("superagent");k=require("cruder");g=(function(){function n(o){this.key=o;this.getList=j(this.getList,this);this.subscribe=j(this.subscribe,this);this.call=j(this.call,this)}n.prototype.call=function(q,o,p){return f.get("http://api.unisender.com/ru/api/"+q+"?format=json&api_key="+this.key).query(o).end(p)};n.prototype.subscribe=function(o){var p=this;return this.getList(function(q){var r;r={list_ids:q,fields:{email:o}};return p.call("subscribe",r)})};n.prototype.getList=function(p){var o=this;return this.call("getLists",{},function(r){var s,q;q="polartour.ru";s=false;r.body.result.forEach(function(t){if(t.title===q){return s=t}});if(s){p(s.id)}return o.call("createList",{title:q},function(t){return p(t.body.result.id)})})};return n})();k=require("cruder");module.exports=function(W,af){var y,ai,r,B,o,Y,al,L,w,at,au,t,K,J,aw,ab,ac,z,X,v,C,D,aj,p,E,ay,ak,H,G,F,Q,ah,ax,ar,ap,ae,P,s,ad,M,I,T,Z,O,an,ag,n,aq,am,A,q,S,R,N,U,aa,ao,av,x,u,V;af();af=function(){};am=W.get("connection");R=W.get("mongoose");n=W.get("app");ai=new R.Schema({position:{type:"number",required:true},size:{type:"string",required:true},type:{type:"string",required:true,"default":"image"},content:{type:"mixed"},createdAt:{type:Date,"default":Date.now}});y=am.model("banners",ai);k(n,y,{query:y.find().sort("position")},function(az,aA){if(az==="post"){return W.get("data notify")("banners","Баннеры",aA)}});n.patch("/banners",function(aB,aA){var aD,aC,az;az=[];aD={};aB.body.forEach(function(aE){return aD[aE._id]=aE});aC={_id:{$in:Object.keys(aD)}};return y.find(aC,function(aE,aG){var aF;if(aE){return aA.send(500)}aG.forEach(function(aL){var aI,aK,aJ,aH;aJ=aD[aL._id];aH=[];for(aI in aJ){aK=aJ[aI];aH.push(aL[aI]=aK)}return aH});aF=function(aH,aI){return aH.save(function(){az.push(aH);return aI()})};return e.forEachSeries(aG,aF,function(){return aA.send(200,az)})})});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");B=new R.Schema({agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},number:{type:"string",required:true},tourists:[String],createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});r=am.model("certificates",B);N={checkAuth:["list","get","put","delete"],query:r.find().sort("-createdAt")};k(n,r,N,function(az,aA){if(az==="post"){W.get("data notify")(aA)}if(az==="get"&&!aA.viewed){aA.viewed=true;return aA.save()}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");Y=new R.Schema({country:{type:"string",required:true},operator:{type:"string",required:true},description:{type:"string",required:true},price:{type:String,required:true},createdAt:{type:Date,"default":Date.now}});o=am.model("charges",Y);k(n,o,{query:o.find().sort("-createdAt")},function(az,aA){if(az==="post"){return W.get("data notify")("charges","Доплаты",aA)}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");t=new R.Schema({email:{type:"string",required:true},comment:{type:"string"}});J=new R.Schema({name:{type:"string",required:true},lastname:{type:"string",required:true},responsibilities:Array,phone:{type:"string",required:true},emails:[au]});L=new R.Schema({name:{type:"string",required:true},email:{type:"string",required:true},phone:{type:"string"},schedule:{type:"string",required:true},employees:[J],createdAt:{type:Date,"default":Date.now}});al=am.model("contacts",L);K=am.model("employees",J);au=am.model("employee-emails",t);k(n,al,{query:al.find().sort("name")},function(az,aA){if(az==="post"){return W.get("data notify")("contacts","Контакты",aA)}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");W.set("data notify",function(aI,aF,aA){var aC,aD,aB,aH,aE,az;aE=W.get("data notify emails path")||m.join(__dirname,"..","..","email");aB=W.get("data notify emails")||{};az=W.get("mailer transport");aC=function(aN){var aL,aJ,aM,aK;aJ="";for(aL in aN){aM=aN[aL];if(aL[0]!=="_"){if(typeof aM==="object"&&(aM.isArray||{}.toString.call(aM)==="[object Array]")){aK=[];aM.forEach(function(aO){if(typeof aO==="string"){return aK.push(aO)}else{return aK.push(aC(aO))}});aJ+=""+aL+": "+(aK.join(","))+"\n"}else{if(typeof aM==="object"){aJ+=""+aL+": "+(aC(aM))+"\n"}else{aJ+=""+aL+": "+aM+"\n"}}}}return aJ};if(!aB[aI]){return}N={to:aB[aI].join(","),subject:aF};try{aH=i.readFileSync(""+aE+"/"+aI+".jade");N.html=c.compile(aH)(aA)}catch(aG){aD=aG;N.text=aC(aA.toObject())}return az.sendMail(N)});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");at=new R.Schema({email:{type:"string",required:true},organization:{type:"string",required:true},inn:{type:"string",required:true},numbers:{type:"string",required:true},address:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});w=am.model("documents",at);N={checkAuth:["list","get","put","delete"],query:w.find().sort("-createdAt")};k(n,w,N,function(az,aA){if(az==="post"){W.get("data notify")("documents-request","Бух. документы",aA)}if(az==="get"&&!aA.viewed){aA.viewed=true;return aA.save()}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");ab=new R.Schema({country:{type:"string",required:true},name:{type:"string",required:true},description:{type:"string",required:true},duration:{type:String},transport:{type:String},place:{type:String},price:{type:String},images:Array,createdAt:{type:Date,"default":Date.now}});aw=am.model("excursions",ab);k(n,aw,{query:aw.find().sort("-name")},function(az,aA){if(az==="post"){return W.get("data notify")("excursions","Экскурсии",aA)}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");z=new R.Schema({name:{type:"string",required:true},code:{type:"string",required:true},description:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});ac=am.model("form-descriptions",z);ag=["list","post","delete"];k(n,ac,{query:ac.find().sort("name"),actions:ag},function(az,aA){if(az==="post"){return W.get("data notify")("form-description","Описание форм",aA)}});n.get("/form-descriptions/:code",function(aA,az){return ac.findOne({code:aA.params.code},function(aB,aC){if(aB){return az.send(500)}if(!aC){return az.send(404)}return az.send(aC)})});n.put("/form-descriptions/:code",function(aA,az){var aB;aB=aA.body;if(aB._id){delete aB._id}return ac.findOne({code:aA.params.code},function(aC,aD){if(aC){return az.send(500)}if(!aD){return az.send(404)}if(aB.description){aD.description=aB.description}return aD.save(function(aE){if(aE){return az.send(500)}az.set("Location",aA.url);return az.send(200,aD)})})});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");s=new R.Schema({name:{type:"string",require:true},description:{type:"string"}});D=new R.Schema({name:{type:"string",required:true},category:{type:"string",required:true},description:{type:"string",required:true},country:{type:"string",required:true},region:{type:"string",required:true},rooms:[s],services:{type:Array},infrastructure:{type:Array},locationDescription:{type:"string",required:true},location:{type:Array},adress:{type:"string"},phone:{type:"string"},fax:{type:"string"},email:{type:"string"},site:{type:"string"},images:Array,samo:{type:"string"},createdAt:{type:Date,"default":Date.now}});C=am.model("hotels",D);P=am.model("rooms",s);k(n,C,{query:C.find().sort("name"),bindParams:true},function(az,aA){if(az==="post"){return W.get("data notify")("hotels","Отели",aA)}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");ad=new R.Schema({name:{type:"string",required:true},href:{type:"string",required:true},newWindow:{type:Boolean,"default":false},position:{type:"number",required:true,"default":0},active:{type:Boolean,"default":true}});p=new R.Schema({name:{type:"string",required:true},href:{type:"string",required:true},type:{type:"string",required:true},position:{type:"number",required:true,"default":0},newWindow:{type:Boolean,"default":false},active:{type:Boolean,"default":true},submenu:[ad],createdAt:{type:Date,"default":Date.now}});aj=am.model("menu",p);k(n,aj,{query:aj.find().sort({position:"ascending"},function(az,aA){if(az==="post"){return W.get("data notify")("menu","Меню",aA)}})});n.patch("/menu",function(aB,aA){var aD,aC,az;az=[];aD={};aB.body.forEach(function(aE){return aD[aE._id]=aE});aC={_id:{$in:Object.keys(aD)}};return aj.find(aC,function(aE,aG){var aF;if(aE){return aA.send(500)}aG.forEach(function(aH){var aI;aI=aD[aH._id];aH.position=aI.position;aH.href=aI.href;aH.name=aI.name;aH.newWindow=aI.newWindow;aH.active=aI.active;return aI.submenu.forEach(function(aJ){if(!aJ._id){aH.submenu.push(aJ)}return aH.submenu.forEach(function(aK){if(aJ._id===aK._id.toString()){aK.position=aJ.position;aK.href=aJ.href;aK.name=aJ.name;aK.newWindow=aJ.newWindow;return aK.active=aJ.active}})})});aF=function(aH,aI){return aH.save(function(){az.push(aH);return aI()})};return e.forEachSeries(aG,aF,function(){return aA.send(200,az)})})});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");ay=new R.Schema({title:{type:"string",required:true},description:{type:"string",required:true},body:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},startAt:{type:Date,"default":Date.now},important:Boolean});E=am.model("news",ay);k(n,E,{query:E.find().sort("-createdAt")},function(az,aA){if(az==="post"){return W.get("data notify")("news","Новости",aA)}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");H=new R.Schema({name:{type:"string",required:true},description:{type:"string",required:true},href:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});ak=am.model("pages",H);k(n,ak,{query:ak.find()},function(az,aA){if(az==="post"){return W.get("data notify")("pages","Страницы",aA)}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");F=new R.Schema({name:{type:"string",required:true}});v=new R.Schema({name:{type:"string",required:true},users:Array,permissions:Array});G=am.model("permissions",F);X=am.model("groups",v);an=am.model("users");n.use(function(aB,aA,aC){var az;az=aB.user?aB.user.username:"anonym";return X.find({users:az},function(aD,aE){if(aD){return aC()}return aC()})});k(n,G,{query:G.find()});k(n,X,{query:X.find()});k(n,an,{query:an.find()});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");ah=new R.Schema({name:{type:"string",required:true},phones:[String],createdAt:{type:Date,"default":Date.now}});Q=am.model("phones",ah);k(n,Q,{query:Q.find().sort("-name")},function(az,aA){if(az==="post"){return W.get("data notify")("phones","Телефоны",aA)}});af();x=W.get("rates refresh interval",600000);S=W.get("logger");n=W.get("app");u=W.get("rates url","http://polartour.ru/samo/default.php?page=currency");q=W.get("rates host");aa=W.get("rates port",1433);V=W.get("rates username");U=W.get("rates password");aq=W.get("rates client","mssql");ao=(function(){switch(aq){case"mssql":return new a(q,aa,V,U);default:return new d(u)}})();A=true;(av=function(){S.info("refreshing rates");return ao.refresh(function(aB,aI){var aG,aE,aA,az,aH,aC,aF,aD;if(A){A=false;af()}if(aB){az=60000;aH="rates refreshing failed"}else{az=x;aH="rates refreshing succeed";for(aA in aI.rates){aG=[];aD=aI.currencies;for(aC=0,aF=aD.length;aC<aF;aC++){aE=aD[aC];aG.push(""+aE+"="+aI.rates[aA][aE])}S.info("rates for "+aA,aG.join(", "))}}S.info(aH,"retry in "+(az/1000)+"s");return setTimeout(av,az)})})();n.get("/rates",function(aA,az){if(ao.result){return az.send(ao.result)}else{return az.send(500)}});am=W.get("connection");R=W.get("mongoose");n=W.get("app");ar=new R.Schema({name:{type:"string",required:true},email:{type:"string",required:true},message:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});ax=am.model("reports",ar);N={checkAuth:["list","get","put","delete"],query:ax.find().sort("-createdAt")};k(n,ax,N,function(az,aA){if(az==="post"){W.get("data notify")("reports","Отзывы",aA)}if(az==="get"&&!aA.viewed){aA.viewed=true;return aA.save()}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");T=new R.Schema({gender:{type:"string",required:true,"default":"male"},fio:{type:"string",required:true},birthday:{type:"string",required:true},series:{type:"string",required:true},number:{type:"string",required:true},validity:{type:Date,required:true},date:{type:Date,required:true},who:{type:"string",required:true},citizenship:{type:"string",required:true}});ae=new R.Schema({city:{type:"string",required:true},agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},address:{type:"string",required:true},departure:{type:"string",required:true},country:{type:"string",required:true},tour:{type:"string",required:true},hotel:{type:"string",required:true},placing:{type:"string",required:true},dateFrom:{type:Date},dateTo:{type:Date},nights:{type:"number"},count:{type:"number",required:true},price:{type:"number",required:true},number:{type:"string",required:true},tourists:[T],comment:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});ap=am.model("reservations",ae);N={checkAuth:["list","get","put","delete"],query:ap.find().sort("-createdAt")};k(n,ap,N,function(az,aA){if(az==="post"){W.get("data notify")("reservations","Заявки на бронь",aA)}if(az==="get"&&!aA.viewed){aA.viewed=true;return aA.save()}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");I=new R.Schema({email:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});M=am.model("subscriptions",I);n.get("/subscriptions/export",function(aA,az){if(!aA.user){return az.send(401)}return M.find(function(aC,aD){var aB;if(aC){return az.send(500)}aB="";(aD||[]).forEach(function(aG){var aF,aI,aE,aH;aE=[];aH=aG.toObject();for(aF in aH){aI=aH[aF];if(aF[0]!=="_"){aE.push(aI)}}aB+=aE.join(",");return aB+="\r\n"});az.setHeader("Content-Type","text/csv");return az.send(aB)})});N={checkAuth:["list","get","put","delete"],query:M.find().sort("-createdAt")};k(n,M,N,function(aB,aC){var aA,az;if(aB==="post"){W.get("data notify")("subscriptions","Подписки",aC);aA=W.get("unisender key");if(!aA){return}az=new g(aA);az.subscribe(aC.email)}if(aB==="get"&&!aC.viewed){aC.viewed=true;return aC.save()}});af();am=W.get("connection");R=W.get("mongoose");n=W.get("app");O=new R.Schema({name:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});Z=am.model("towns",O);k(n,Z,{query:Z.find()},function(az,aA){if(az==="post"){return W.get("data notify")("towns","Новый город",aA)}});return af()}}).call(this);