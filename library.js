(function(){var d,a,g,e,k,l,i,c,b,m,f,h,j=function(n,o){return function(){return n.apply(o,arguments)}};k=require("cruder");e=require("async");k=require("cruder");k=require("cruder");k=require("cruder");c=require("jade");m=require("path");i=require("fs");k=require("cruder");k=require("cruder");k=require("cruder");k=require("cruder");k=require("cruder");e=require("async");k=require("cruder");k=require("cruder");k=require("cruder");k=require("cruder");l=require("dateformat");b=require("jsdom");h=require("tds");d=(function(){function n(o){this.url=o;this.result=null}n.prototype.refresh=function(p){var o=this;return b.env({url:this.url,scripts:["http://code.jquery.com/jquery.js"],done:function(s,r){var t,q;if(s){p(s);return}if(r.document.innerHTML.indexOf("page not found")>=0){p("page not found");return}q={currencies:[],rates:{}};t=r.$;t("thead td").each(function(){return q.currencies.push(t(this).text().trim())});t("tbody tr").each(function(){var u;u=t("th",this).text().trim();q.rates[u]={};return t("td",this).each(function(w){var v;v=q.currencies[w];return q.rates[u][v]=t(this).text().trim()})});o.result=q;return p(null,q)}})};return n})();a=(function(){function n(q,o,r,p){this.host=q;this.port=o;this.username=r;this.password=p;this.result=null;this.connection=null}n.prototype.refresh=function(q){var o,p=this;if(this.connection){return this._refresh(q)}else{o=new h.Connection({host:this.host,port:this.port,userName:this.username,password:this.password});return o.connect(function(r){if(r){return q(r)}else{p.connection=o;p.connection.on("error",function(){p.connection.end();return p.connection=null});return p._refresh(q)}})}};n.prototype._refresh=function(s){var p,o,q,r=this;p=l("dd.mm.yyyy");o={currencies:[],rates:{}};o.rates[p]={};q=this.connection.createStatement("EXEC up_WEB_3_job_currency");q.on("row",function(u){var w,t,v;t=u.getValue("rate");w=u.getValue("alias_from");v=u.getValue("alias_to");if(v==="RUB"){if(o.currencies.indexOf(w)===-1){o.currencies.push(w);return o.rates[p][w]=t}}});q.on("done",function(){r.result=o;return s(null,o)});return q.execute()};return n})();k=require("cruder");k=require("cruder");f=require("superagent");k=require("cruder");g=(function(){function n(o){this.key=o;this.getList=j(this.getList,this);this.subscribe=j(this.subscribe,this);this.call=j(this.call,this)}n.prototype.call=function(q,o,p){return f.get("http://api.unisender.com/ru/api/"+q+"?format=json&api_key="+this.key).query(o).end(p)};n.prototype.subscribe=function(o){var p=this;return this.getList(function(q){var r;r={list_ids:q,fields:{email:o}};return p.call("subscribe",r)})};n.prototype.getList=function(p){var o=this;return this.call("getLists",{},function(r){var s,q;q="polartour.ru";s=false;r.body.result.forEach(function(t){if(t.title===q){return s=t}});if(s){p(s.id)}return o.call("createList",{title:q},function(t){return p(t.body.result.id)})})};return n})();k=require("cruder");module.exports=function(X,ag){var y,aj,r,B,o,Z,am,M,w,au,av,t,L,K,ax,ac,ad,z,Y,v,C,D,ak,p,E,az,al,I,H,F,R,ai,ay,at,aq,af,Q,s,ae,N,J,U,aa,P,ao,ah,n,ar,an,A,G,q,T,S,O,V,ab,ap,aw,x,u,W;ag();ag=function(){};an=X.get("connection");S=X.get("mongoose");n=X.get("app");aj=new S.Schema({position:{type:"number",required:true},size:{type:"string",required:true},type:{type:"string",required:true,"default":"image"},content:{type:"mixed"},createdAt:{type:Date,"default":Date.now}});y=an.model("banners",aj);k(n,y,{query:y.find().sort("position")},function(aA,aB){if(aA==="post"){return X.get("data notify")("banners","Баннеры",aB)}});n.patch("/banners",function(aC,aB){var aE,aD,aA;aA=[];aE={};aC.body.forEach(function(aF){return aE[aF._id]=aF});aD={_id:{$in:Object.keys(aE)}};return y.find(aD,function(aF,aH){var aG;if(aF){return aB.send(500)}aH.forEach(function(aM){var aJ,aL,aK,aI;aK=aE[aM._id];aI=[];for(aJ in aK){aL=aK[aJ];aI.push(aM[aJ]=aL)}return aI});aG=function(aI,aJ){return aI.save(function(){aA.push(aI);return aJ()})};return e.forEachSeries(aH,aG,function(){return aB.send(200,aA)})})});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");B=new S.Schema({agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},number:{type:"string",required:true},tourists:[String],createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});r=an.model("certificates",B);O={checkAuth:["list","get","put","delete"],query:r.find().sort("-createdAt")};k(n,r,O,function(aA,aB){if(aA==="post"){X.get("data notify")(aB)}if(aA==="get"&&!aB.viewed){aB.viewed=true;return aB.save()}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");Z=new S.Schema({country:{type:"string",required:true},operator:{type:"string",required:true},description:{type:"string",required:true},price:{type:String,required:true},createdAt:{type:Date,"default":Date.now}});o=an.model("charges",Z);k(n,o,{query:o.find().sort("-createdAt")},function(aA,aB){if(aA==="post"){return X.get("data notify")("charges","Доплаты",aB)}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");t=new S.Schema({email:{type:"string",required:true},comment:{type:"string"}});K=new S.Schema({name:{type:"string",required:true},lastname:{type:"string",required:true},responsibilities:Array,phone:{type:"string",required:true},emails:[av]});M=new S.Schema({name:{type:"string",required:true},email:{type:"string",required:true},phone:{type:"string"},schedule:{type:"string",required:true},employees:[K],createdAt:{type:Date,"default":Date.now}});am=an.model("contacts",M);L=an.model("employees",K);av=an.model("employee-emails",t);k(n,am,{query:am.find().sort("name")},function(aA,aB){if(aA==="post"){return X.get("data notify")("contacts","Контакты",aB)}});ag();an=X.get("connection");S=X.get("mongoose");G=X.get("data notify from");n=X.get("app");X.set("data notify",function(aJ,aG,aB){var aD,aE,aC,aI,aF,aA;aF=X.get("data notify emails path")||m.join(__dirname,"..","..","email");aC=X.get("data notify emails")||{};aA=X.get("mailer transport");aD=function(aO){var aM,aK,aN,aL;aK="";for(aM in aO){aN=aO[aM];if(aM[0]!=="_"){if(typeof aN==="object"&&(aN.isArray||{}.toString.call(aN)==="[object Array]")){aL=[];aN.forEach(function(aP){if(typeof aP==="string"){return aL.push(aP)}else{return aL.push(aD(aP))}});aK+=""+aM+": "+(aL.join(","))+"\n"}else{if(typeof aN==="object"){aK+=""+aM+": "+(aD(aN))+"\n"}else{aK+=""+aM+": "+aN+"\n"}}}}return aK};if(!aC[aJ]){return}O={to:aC[aJ].join(","),from:G,subject:aG};try{aI=i.readFileSync(""+aF+"/"+aJ+".jade");O.html=c.compile(aI)(aB)}catch(aH){aE=aH;O.text=aD(aB.toObject())}return aA.sendMail(O)});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");au=new S.Schema({email:{type:"string",required:true},organization:{type:"string",required:true},inn:{type:"string",required:true},numbers:{type:"string",required:true},address:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});w=an.model("documents",au);O={checkAuth:["list","get","put","delete"],query:w.find().sort("-createdAt")};k(n,w,O,function(aA,aB){if(aA==="post"){X.get("data notify")("documents-request","Бух. документы",aB)}if(aA==="get"&&!aB.viewed){aB.viewed=true;return aB.save()}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");ac=new S.Schema({country:{type:"string",required:true},name:{type:"string",required:true},description:{type:"string",required:true},duration:{type:String},transport:{type:String},place:{type:String},price:{type:String},images:Array,createdAt:{type:Date,"default":Date.now}});ax=an.model("excursions",ac);k(n,ax,{query:ax.find().sort("-name")},function(aA,aB){if(aA==="post"){return X.get("data notify")("excursions","Экскурсии",aB)}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");z=new S.Schema({name:{type:"string",required:true},code:{type:"string",required:true},description:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});ad=an.model("form-descriptions",z);ah=["list","post","delete"];k(n,ad,{query:ad.find().sort("name"),actions:ah},function(aA,aB){if(aA==="post"){return X.get("data notify")("form-description","Описание форм",aB)}});n.get("/form-descriptions/:code",function(aB,aA){return ad.findOne({code:aB.params.code},function(aC,aD){if(aC){return aA.send(500)}if(!aD){return aA.send(404)}return aA.send(aD)})});n.put("/form-descriptions/:code",function(aB,aA){var aC;aC=aB.body;if(aC._id){delete aC._id}return ad.findOne({code:aB.params.code},function(aD,aE){if(aD){return aA.send(500)}if(!aE){return aA.send(404)}if(aC.description){aE.description=aC.description}return aE.save(function(aF){if(aF){return aA.send(500)}aA.set("Location",aB.url);return aA.send(200,aE)})})});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");s=new S.Schema({name:{type:"string",require:true},description:{type:"string"}});D=new S.Schema({name:{type:"string",required:true},category:{type:"string",required:true},description:{type:"string",required:true},country:{type:"string",required:true},region:{type:"string",required:true},rooms:[s],services:{type:Array},infrastructure:{type:Array},locationDescription:{type:"string",required:true},location:{type:Array},adress:{type:"string"},phone:{type:"string"},fax:{type:"string"},email:{type:"string"},site:{type:"string"},images:Array,samo:{type:"string"},createdAt:{type:Date,"default":Date.now}});C=an.model("hotels",D);Q=an.model("rooms",s);k(n,C,{query:C.find().sort("name"),bindParams:true},function(aA,aB){if(aA==="post"){return X.get("data notify")("hotels","Отели",aB)}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");ae=new S.Schema({name:{type:"string",required:true},href:{type:"string",required:true},newWindow:{type:Boolean,"default":false},position:{type:"number",required:true,"default":0},active:{type:Boolean,"default":true}});p=new S.Schema({name:{type:"string",required:true},href:{type:"string",required:true},type:{type:"string",required:true},position:{type:"number",required:true,"default":0},newWindow:{type:Boolean,"default":false},active:{type:Boolean,"default":true},submenu:[ae],createdAt:{type:Date,"default":Date.now}});ak=an.model("menu",p);k(n,ak,{query:ak.find().sort({position:"ascending"},function(aA,aB){if(aA==="post"){return X.get("data notify")("menu","Меню",aB)}})});n.patch("/menu",function(aC,aB){var aE,aD,aA;aA=[];aE={};aC.body.forEach(function(aF){return aE[aF._id]=aF});aD={_id:{$in:Object.keys(aE)}};return ak.find(aD,function(aF,aH){var aG;if(aF){return aB.send(500)}aH.forEach(function(aI){var aJ;aJ=aE[aI._id];aI.position=aJ.position;aI.href=aJ.href;aI.name=aJ.name;aI.newWindow=aJ.newWindow;aI.active=aJ.active;return aJ.submenu.forEach(function(aK){if(!aK._id){aI.submenu.push(aK)}return aI.submenu.forEach(function(aL){if(aK._id===aL._id.toString()){aL.position=aK.position;aL.href=aK.href;aL.name=aK.name;aL.newWindow=aK.newWindow;return aL.active=aK.active}})})});aG=function(aI,aJ){return aI.save(function(){aA.push(aI);return aJ()})};return e.forEachSeries(aH,aG,function(){return aB.send(200,aA)})})});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");az=new S.Schema({title:{type:"string",required:true},description:{type:"string",required:true},body:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},startAt:{type:Date,"default":Date.now},important:Boolean});E=an.model("news",az);k(n,E,{query:E.find().sort("-createdAt")},function(aA,aB){if(aA==="post"){return X.get("data notify")("news","Новости",aB)}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");I=new S.Schema({name:{type:"string",required:true},description:{type:"string",required:true},href:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});al=an.model("pages",I);k(n,al,{query:al.find()},function(aA,aB){if(aA==="post"){return X.get("data notify")("pages","Страницы",aB)}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");F=new S.Schema({name:{type:"string",required:true}});v=new S.Schema({name:{type:"string",required:true},users:Array,permissions:Array});H=an.model("permissions",F);Y=an.model("groups",v);ao=an.model("users");n.use(function(aC,aB,aD){var aA;aA=aC.user?aC.user.username:"anonym";return Y.find({users:aA},function(aE,aF){if(aE){return aD()}return aD()})});k(n,H,{query:H.find()});k(n,Y,{query:Y.find()});k(n,ao,{query:ao.find()});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");ai=new S.Schema({name:{type:"string",required:true},phones:[String],createdAt:{type:Date,"default":Date.now}});R=an.model("phones",ai);k(n,R,{query:R.find().sort("-name")},function(aA,aB){if(aA==="post"){return X.get("data notify")("phones","Телефоны",aB)}});ag();x=X.get("rates refresh interval",600000);T=X.get("logger");n=X.get("app");u=X.get("rates url","http://polartour.ru/samo/default.php?page=currency");q=X.get("rates host");ab=X.get("rates port",1433);W=X.get("rates username");V=X.get("rates password");ar=X.get("rates client","mssql");ap=(function(){switch(ar){case"mssql":return new a(q,ab,W,V);default:return new d(u)}})();A=true;(aw=function(){T.info("refreshing rates");return ap.refresh(function(aC,aJ){var aH,aF,aB,aA,aI,aD,aG,aE;if(A){A=false;ag()}if(aC){aA=60000;aI="rates refreshing failed"}else{aA=x;aI="rates refreshing succeed";for(aB in aJ.rates){aH=[];aE=aJ.currencies;for(aD=0,aG=aE.length;aD<aG;aD++){aF=aE[aD];aH.push(""+aF+"="+aJ.rates[aB][aF])}T.info("rates for "+aB,aH.join(", "))}}T.info(aI,"retry in "+(aA/1000)+"s");return setTimeout(aw,aA)})})();n.get("/rates",function(aB,aA){if(ap.result){return aA.send(ap.result)}else{return aA.send(500)}});an=X.get("connection");S=X.get("mongoose");n=X.get("app");at=new S.Schema({name:{type:"string",required:true},email:{type:"string",required:true},message:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});ay=an.model("reports",at);O={checkAuth:["list","get","put","delete"],query:ay.find().sort("-createdAt")};k(n,ay,O,function(aA,aB){if(aA==="post"){X.get("data notify")("reports","Отзывы",aB)}if(aA==="get"&&!aB.viewed){aB.viewed=true;return aB.save()}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");U=new S.Schema({gender:{type:"string",required:true,"default":"male"},fio:{type:"string",required:true},birthday:{type:"string",required:true},series:{type:"string",required:true},number:{type:"string",required:true},validity:{type:Date,required:true},date:{type:Date,required:true},who:{type:"string",required:true},citizenship:{type:"string",required:true}});af=new S.Schema({city:{type:"string",required:true},agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},address:{type:"string",required:true},departure:{type:"string",required:true},country:{type:"string",required:true},tour:{type:"string",required:true},hotel:{type:"string",required:true},placing:{type:"string",required:true},dateFrom:{type:Date},dateTo:{type:Date},nights:{type:"number"},count:{type:"number",required:true},price:{type:"number",required:true},number:{type:"string",required:true},tourists:[U],comment:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});aq=an.model("reservations",af);O={checkAuth:["list","get","put","delete"],query:aq.find().sort("-createdAt")};k(n,aq,O,function(aA,aB){if(aA==="post"){X.get("data notify")("reservations","Заявки на бронь",aB)}if(aA==="get"&&!aB.viewed){aB.viewed=true;return aB.save()}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");J=new S.Schema({email:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});N=an.model("subscriptions",J);n.get("/subscriptions/export",function(aB,aA){if(!aB.user){return aA.send(401)}return N.find(function(aD,aE){var aC;if(aD){return aA.send(500)}aC="";(aE||[]).forEach(function(aH){var aG,aJ,aF,aI;aF=[];aI=aH.toObject();for(aG in aI){aJ=aI[aG];if(aG[0]!=="_"){aF.push(aJ)}}aC+=aF.join(",");return aC+="\r\n"});aA.setHeader("Content-Type","text/csv");return aA.send(aC)})});O={checkAuth:["list","get","put","delete"],query:N.find().sort("-createdAt")};k(n,N,O,function(aC,aD){var aB,aA;if(aC==="post"){X.get("data notify")("subscriptions","Подписки",aD);aB=X.get("unisender key");if(!aB){return}aA=new g(aB);aA.subscribe(aD.email)}if(aC==="get"&&!aD.viewed){aD.viewed=true;return aD.save()}});ag();an=X.get("connection");S=X.get("mongoose");n=X.get("app");P=new S.Schema({name:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});aa=an.model("towns",P);k(n,aa,{query:aa.find()},function(aA,aB){if(aA==="post"){return X.get("data notify")("towns","Новый город",aB)}});return ag()}}).call(this);