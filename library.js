(function(){var e,a,h,f,b,l,n,m,j,d,c,o,g,i,k=function(p,q){return function(){return p.apply(q,arguments)}};l=require("cruder");f=require("async");l=require("cruder");l=require("cruder");l=require("cruder");l=require("cruder");d=require("jade");o=require("path");j=require("fs");l=require("cruder");l=require("cruder");m=require("fileupload");l=require("cruder");o=require("path");l=require("cruder");g=require("superagent");l=require("cruder");c=require("jsdom");b=require("memory-cache");l=require("cruder");f=require("async");l=require("cruder");l=require("cruder");l=require("cruder");l=require("cruder");n=require("dateformat");c=require("jsdom");i=require("tds");e=(function(){function p(q){this.url=q;this.result=null}p.prototype.refresh=function(r){var q=this;return c.env({url:this.url,scripts:["http://code.jquery.com/jquery.js"],done:function(u,t){var v,s;if(u){r(u);return}if(t.document.innerHTML.indexOf("page not found")>=0){r("page not found");return}s={currencies:[],rates:{}};v=t.$;v("thead td").each(function(){return s.currencies.push(v(this).text().trim())});v("tbody tr").each(function(){var w;w=v("th",this).text().trim();s.rates[w]={};return v("td",this).each(function(y){var x;x=s.currencies[y];return s.rates[w][x]=v(this).text().trim()})});q.result=s;return r(null,s)}})};return p})();a=(function(){function p(s,q,t,r){this.host=s;this.port=q;this.username=t;this.password=r;this.result=null;this.connection=null}p.prototype.refresh=function(s){var q,r=this;if(this.connection){return this._refresh(s)}else{q=new i.Connection({host:this.host,port:this.port,userName:this.username,password:this.password});return q.connect(function(t){if(t){return s(t)}else{r.connection=q;r.connection.on("error",function(){r.connection.end();return r.connection=null});return r._refresh(s)}})}};p.prototype._refresh=function(u){var r,q,s,t=this;r=n("dd.mm.yyyy");q={currencies:[],rates:{}};q.rates[r]={};s=this.connection.createStatement("EXEC up_WEB_3_job_currency");s.on("row",function(w){var y,v,x;v=w.getValue("rate");y=w.getValue("alias_from");x=w.getValue("alias_to");if(x==="RUB"){if(q.currencies.indexOf(y)===-1){q.currencies.push(y);return q.rates[r][y]=v}}});s.on("done",function(){t.result=q;return u(null,q)});return s.execute()};return p})();l=require("cruder");l=require("cruder");g=require("superagent");l=require("cruder");h=(function(){function p(q){this.key=q;this.getList=k(this.getList,this);this.subscribe=k(this.subscribe,this);this.call=k(this.call,this)}p.prototype.call=function(s,q,r){return g.get("http://api.unisender.com/ru/api/"+s+"?format=json&api_key="+this.key).query(q).end(r)};p.prototype.subscribe=function(q){var r=this;return this.getList(function(s){var t;t={list_ids:s,fields:{email:q}};return r.call("subscribe",t)})};p.prototype.getList=function(r){var q=this;return this.call("getLists",{},function(t){var u,s;s="polartour.ru";u=false;t.body.result.forEach(function(v){if(v.title===s){return u=v}});if(u){r(u.id)}return q.call("createList",{title:s},function(v){return r(v.body.result.id)})})};return p})();l=require("cruder");module.exports=function(ao,R){var M,az,aK,ac,ai,ae,aj,aN,aw,y,aa,Q,I,E,A,af,r,P,D,t,ay,aG,B,aL,p,J,V,G,aJ,H,L,W,ah,aH,O,at,aE,aq,aC,aF,al,C,z,w,Y,ak,aD,x,an,u,F,Z,aI,U,S,am,ab,aM,X,v,ag,aA,T,av,ap,ar,ad,ax,au,aB,K,s,N,q;R();R=function(){};U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");az=new v.Schema({position:{type:"number",required:true},size:{type:"string",required:true},type:{type:"string",required:true,"default":"image"},content:{type:"mixed"},createdAt:{type:Date,"default":Date.now}});M=U.model("banners",az);l(F,M,{query:M.find().sort("position")},function(aO,aP){if(aO==="post"){return ao.get("data notify")("banners","Баннеры",aP)}});F.patch("/banners",function(aQ,aP){var aS,aR,aO;aO=[];aS={};aQ.body.forEach(function(aT){return aS[aT._id]=aT});aR={_id:{$in:Object.keys(aS)}};return M.find(aR,function(aT,aV){var aU;if(aT){return aP.send(500)}aV.forEach(function(a0){var aX,aZ,aY,aW;aY=aS[a0._id];aW=[];for(aX in aY){aZ=aY[aX];aW.push(a0[aX]=aZ)}return aW});aU=function(aW,aX){return aW.save(function(){aO.push(aW);return aX()})};return f.forEachSeries(aV,aU,function(){return aP.send(200,aO)})})});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");ac=new v.Schema({agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},number:{type:"string",required:true},tourists:[String],createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});aK=U.model("certificates",ac);ag={checkAuth:["list","get","put","delete"],query:aK.find().sort("-createdAt")};l(F,aK,ag,function(aO,aP){if(aO==="post"){ao.get("data notify")(aP)}if(aO==="get"&&!aP.viewed){aP.viewed=true;return aP.save()}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");ae=new v.Schema({country:{type:"string",required:true},operator:{type:"string",required:true},description:{type:"string",required:true},price:{type:String,required:true},createdAt:{type:Date,"default":Date.now}});ai=U.model("charges",ae);l(F,ai,{query:ai.find().sort("-createdAt")},function(aO,aP){if(aO==="post"){return ao.get("data notify")("charges","Доплаты",aP)}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");aN=new v.Schema({property:{type:"string",required:true},value:{type:"string",required:true}});aj=U.model("configs",aN);l(F,aj,{query:aj.find()});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");E=new v.Schema({email:{type:"string",required:true},comment:{type:"string"}});af=new v.Schema({name:{type:"string",required:true},lastname:{type:"string",required:true},responsibilities:Array,phone:{type:"string",required:true},emails:[I]});y=new v.Schema({name:{type:"string",required:true},email:{type:"string",required:true},phone:{type:"string"},schedule:{type:"string",required:true},employees:[af],createdAt:{type:Date,"default":Date.now}});aw=U.model("contacts",y);A=U.model("employees",af);I=U.model("employee-emails",E);l(F,aw,{query:aw.find().sort("name")},function(aO,aP){if(aO==="post"){return ao.get("data notify")("contacts","Контакты",aP)}});R();U=ao.get("connection");v=ao.get("mongoose");ab=ao.get("data notify from");F=ao.get("app");ao.set("data notify",function(aX,aU,aP){var aR,aS,aQ,aW,aT,aO;aT=ao.get("data notify emails path")||o.join(__dirname,"..","..","email");aQ=ao.get("data notify emails")||{};aO=ao.get("mailer transport");aR=function(a2){var a0,aY,a1,aZ;aY="";for(a0 in a2){a1=a2[a0];if(a0[0]!=="_"){if(typeof a1==="object"&&(a1.isArray||{}.toString.call(a1)==="[object Array]")){aZ=[];a1.forEach(function(a3){if(typeof a3==="string"){return aZ.push(a3)}else{return aZ.push(aR(a3))}});aY+=""+a0+": "+(aZ.join(","))+"\n"}else{if(typeof a1==="object"){aY+=""+a0+": "+(aR(a1))+"\n"}else{aY+=""+a0+": "+a1+"\n"}}}}return aY};if(!aQ[aX]){return}ag={to:aQ[aX].join(","),from:ab,subject:aU};try{aW=j.readFileSync(""+aT+"/"+aX+".jade");ag.html=d.compile(aW)(aP)}catch(aV){aS=aV;ag.text=aR(aP.toObject())}return aO.sendMail(ag)});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");Q=new v.Schema({email:{type:"string",required:true},organization:{type:"string",required:true},inn:{type:"string",required:true},numbers:{type:"string",required:true},address:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});aa=U.model("documents",Q);ag={checkAuth:["list","get","put","delete"],query:aa.find().sort("-createdAt")};l(F,aa,ag,function(aO,aP){if(aO==="post"){ao.get("data notify")("documents-request","Бух. документы",aP)}if(aO==="get"&&!aP.viewed){aP.viewed=true;return aP.save()}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");P=new v.Schema({country:{type:"string",required:true},name:{type:"string",required:true},description:{type:"string",required:true},duration:{type:String},transport:{type:String},place:{type:String},price:{type:String},images:Array,createdAt:{type:Date,"default":Date.now}});r=U.model("excursions",P);l(F,r,{query:r.find().sort("-name")},function(aO,aP){if(aO==="post"){return ao.get("data notify")("excursions","Экскурсии",aP)}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");t=new v.Schema({basename:{type:"string",required:true},path:{type:"string",required:true}});D=U.model("files",t);l(F,D,{query:D.find(),actions:["list","delete"]});Z=ao.get("application directory");ar=o.join(Z,"public");ar=ao.get("public directory",ar);s=o.join(ar,"uploads");s=ao.get("uploads directory",s);av=s.replace(ar,"");K=m.createFileUpload(s).middleware;F.post("/files",K,function(aQ,aO){var aP;aP=[];aQ.body.files.forEach(function(aR){aR.path=""+av+"/"+aR.path+aR.basename;(new D(aR)).save();return aP.push(aR)});return aO.send({files:aP})});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");aG=new v.Schema({name:{type:"string",required:true},code:{type:"string",required:true},description:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});ay=U.model("form-descriptions",aG);u=["list","post","delete"];l(F,ay,{query:ay.find().sort("name"),actions:u},function(aO,aP){if(aO==="post"){return ao.get("data notify")("form-description","Описание форм",aP)}});F.get("/form-descriptions/:code",function(aP,aO){return ay.findOne({code:aP.params.code},function(aQ,aR){if(aQ){return aO.send(500)}if(!aR){return aO.send(404)}return aO.send(aR)})});F.put("/form-descriptions/:code",function(aP,aO){var aQ;aQ=aP.body;if(aQ._id){delete aQ._id}return ay.findOne({code:aP.params.code},function(aR,aS){if(aR){return aO.send(500)}if(!aS){return aO.send(404)}if(aQ.description){aS.description=aQ.description}return aS.save(function(aT){if(aT){return aO.send(500)}aO.set("Location",aP.url);return aO.send(200,aS)})})});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");C=new v.Schema({name:{type:"string",require:true},description:{type:"string"}});J=new v.Schema({name:{type:"string",required:true},category:{type:"string"},description:{type:"string"},country:{type:"string",required:true},region:{type:"string"},rooms:[C],services:{type:Array},infrastructure:{type:Array},locationDescription:{type:"string"},location:{type:Array},adress:{type:"string"},phone:{type:"string"},fax:{type:"string"},email:{type:"string"},site:{type:"string"},images:Array,samo:{type:"string"},_export:{type:v.Schema.Types.Mixed},createdAt:{type:Date,"default":Date.now}});p=U.model("hotels",J);al=U.model("rooms",C);aB={mow:2,kuf:42,kzn:48,rov:64,svx:70,led:80,ufa:116};S={tr:10,eg:6,th:8,mv:249,"do":311,cu:23,lk:25,ae:26,"in":9,gr:4,es:5,it:70,tn:114,bg:3,cy:51};ap=/ehtml\('(.+)'\); if \(typeof/;F.get("/hotels/:id/prices/:town",function(aQ,aP){var aR,aO;aR="hotel-price:"+aQ.params.id+":"+aQ.params.town;aO=b.get(aR);if(aO){return aP.send(aO.code,aO.response)}return p.findOne({_id:aQ.params.id},function(aV,aX){var aY,aZ,aT,aW,a0,aS,aU;if(aV){return aP.send(500)}if(!aX.samo||!aB[aQ.params.town]){b.put(aR,{code:404},3600000);return aP.send(404)}aS=aB[aQ.params.town];aT=S[aX.country];aZ="20130812";aW="20130825";ab=6;a0=14;aY=2;aU="http://polartour.ru/samo/search_tour?samo_action=PRICES&TOWNFROMINC="+aS+"&CHECKIN_BEG="+aZ+"&NIGHTS_FROM="+ab+"&CHECKIN_END="+aW+"&NIGHTS_TILL="+a0+"&ADULT="+aY+"&HOTELS="+aX.samo+"&CURRENCY=1&STATEINC="+aT;return g.get(aU).end(function(a2,a1){var a3;if(a2){b.put(aR,{code:500},300000);return aP.send(500)}if(!a1.text.match(ap)){b.put(aR,{code:404},3600000);return aP.send(404)}a3=ap.exec(a1.text);a3=a3[1];a3=a3.replace(/\\n\\/g,"\n");a3=a3.replace(/\\"/g,'"');return c.env({html:a3,scripts:["http://code.jquery.com/jquery.js"],done:function(a8,a7){var a4,a6,a5;if(a8){b.put(aR,{code:500},300000);return aP.send(500)}a6=a7.$("tbody tr:eq(0) td:eq(8)").text().trim().split(" ");if(a6.length!==2){b.put(aR,{code:500},300000);return aP.send(500)}a4=a7.$("tbody tr:eq(0) td:eq(2)").text().trim();a5={price:Number(a6[0]),nights:a4,adults:aY,url:aU.replace("samo_action=PRICES&","")+"&DOLOAD=1"};b.put(aR,{code:200,response:a5},3600000);return aP.send(a5)}})})})});F.get("/hotels",function(aP,aO){return p.find().limit(30).sort("name").find(aP.query).exec(function(aQ,aR){if(aQ){return aO.send(500)}return p.find().distinct("country",function(aT,aS){var aU;if(aT){return aO.send(500)}aU=[];aS.forEach(function(aV){return aU.push("/hotels?country="+aV+"; rel=subsection")});aO.set("Link",aU);return aO.send(aR)})})});l(F,p,{query:p.find().sort("name"),bindParams:true},function(aO,aP){if(aO==="post"){return ao.get("data notify")("hotels","Отели",aP)}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");z=new v.Schema({name:{type:"string",required:true},href:{type:"string",required:true},newWindow:{type:Boolean,"default":false},position:{type:"number",required:true,"default":0},active:{type:Boolean,"default":true}});G=new v.Schema({name:{type:"string",required:true},href:{type:"string",required:true},type:{type:"string",required:true},position:{type:"number",required:true,"default":0},newWindow:{type:Boolean,"default":false},active:{type:Boolean,"default":true},submenu:[z],createdAt:{type:Date,"default":Date.now}});V=U.model("menu",G);l(F,V,{query:V.find().sort({position:"ascending"},function(aO,aP){if(aO==="post"){return ao.get("data notify")("menu","Меню",aP)}})});F.patch("/menu",function(aQ,aP){var aS,aR,aO;aO=[];aS={};aQ.body.forEach(function(aT){if(aT._id){return aS[aT._id]=aT}else{return(new V(aT)).save(function(aU,aV){if(!aU){return aO.push(aV)}})}});aR={_id:{$in:Object.keys(aS)}};return V.find(aR,function(aT,aV){var aU;if(aT){return aP.send(500)}aV.forEach(function(aW){var aX;aX=aS[aW._id];aW.position=aX.position;aW.href=aX.href;aW.name=aX.name;aW.newWindow=aX.newWindow;aW.active=aX.active;return aW.submenu=aX.submenu});aU=function(aW,aX){return aW.save(function(){aO.push(aW);return aX()})};return f.forEachSeries(aV,aU,function(){return aP.send(200,aO)})})});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");H=new v.Schema({title:{type:"string",required:true},description:{type:"string",required:true},body:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},startAt:{type:Date,"default":Date.now},important:Boolean});aJ=U.model("news",H);l(F,aJ,{query:aJ.find().sort("-createdAt")},function(aO,aP){if(aO==="post"){return ao.get("data notify")("news","Новости",aP)}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");W=new v.Schema({name:{type:"string",required:true},description:{type:"string",required:true},href:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});L=U.model("pages",W);l(F,L,{query:L.find()},function(aO,aP){if(aO==="post"){return ao.get("data notify")("pages","Страницы",aP)}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");aH=new v.Schema({name:{type:"string",required:true}});aL=new v.Schema({name:{type:"string",required:true},users:Array,permissions:Array});ah=U.model("permissions",aH);B=U.model("groups",aL);an=U.model("users");F.use(function(aQ,aP,aR){var aO;aO=aQ.user?aQ.user.username:"anonym";return B.find({users:aO},function(aS,aT){if(aS){return aR()}return aR()})});l(F,ah,{query:ah.find()});l(F,B,{query:B.find()});l(F,an,{query:an.find()});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");at=new v.Schema({name:{type:"string",required:true},phones:[String],createdAt:{type:Date,"default":Date.now}});O=U.model("phones",at);l(F,O,{query:O.find().sort("-name")},function(aO,aP){if(aO==="post"){return ao.get("data notify")("phones","Телефоны",aP)}});R();au=ao.get("rates refresh interval",600000);X=ao.get("logger");F=ao.get("app");N=ao.get("rates url","http://polartour.ru/samo/default.php?page=currency");aM=ao.get("rates host");T=ao.get("rates port",1433);q=ao.get("rates username");aA=ao.get("rates password");aI=ao.get("rates client","mssql");ad=(function(){switch(aI){case"mssql":return new a(aM,T,q,aA);default:return new e(N)}})();am=true;(ax=function(){X.info("refreshing rates");return ad.refresh(function(aQ,aX){var aV,aT,aP,aO,aW,aR,aU,aS;if(am){am=false;R()}if(aQ){aO=60000;aW="rates refreshing failed"}else{aO=au;aW="rates refreshing succeed";for(aP in aX.rates){aV=[];aS=aX.currencies;for(aR=0,aU=aS.length;aR<aU;aR++){aT=aS[aR];aV.push(""+aT+"="+aX.rates[aP][aT])}X.info("rates for "+aP,aV.join(", "))}}X.info(aW,"retry in "+(aO/1000)+"s");return setTimeout(ax,aO)})})();F.get("/rates",function(aP,aO){if(ad.result){return aO.send(ad.result)}else{return aO.send(500)}});U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");aq=new v.Schema({name:{type:"string",required:true},email:{type:"string",required:true},message:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});aE=U.model("reports",aq);ag={checkAuth:["list","get","put","delete"],query:aE.find().sort("-createdAt")};l(F,aE,ag,function(aO,aP){if(aO==="post"){ao.get("data notify")("reports","Отзывы",aP)}if(aO==="get"&&!aP.viewed){aP.viewed=true;return aP.save()}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");ak=new v.Schema({gender:{type:"string",required:true,"default":"male"},fio:{type:"string",required:true},birthday:{type:"string",required:true},series:{type:"string",required:true},number:{type:"string",required:true},validity:{type:Date,required:true},date:{type:Date,required:true},who:{type:"string",required:true},citizenship:{type:"string",required:true}});aF=new v.Schema({city:{type:"string",required:true},agency:{type:"string",required:true},phone:{type:"string",required:true},email:{type:"string",required:true},address:{type:"string",required:true},departure:{type:"string",required:true},country:{type:"string",required:true},tour:{type:"string",required:true},hotel:{type:"string",required:true},placing:{type:"string",required:true},dateFrom:{type:Date},dateTo:{type:Date},nights:{type:"number"},count:{type:"number",required:true},price:{type:"number",required:true},number:{type:"string",required:true},tourists:[ak],comment:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});aC=U.model("reservations",aF);ag={checkAuth:["list","get","put","delete"],query:aC.find().sort("-createdAt")};l(F,aC,ag,function(aO,aP){if(aO==="post"){ao.get("data notify")("reservations","Заявки на бронь",aP)}if(aO==="get"&&!aP.viewed){aP.viewed=true;return aP.save()}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");Y=new v.Schema({email:{type:"string",required:true},createdAt:{type:Date,"default":Date.now},viewed:{type:Boolean,required:true,"default":false}});w=U.model("subscriptions",Y);F.get("/subscriptions/export",function(aP,aO){if(!aP.user){return aO.send(401)}return w.find(function(aR,aS){var aQ;if(aR){return aO.send(500)}aQ="";(aS||[]).forEach(function(aV){var aU,aX,aT,aW;aT=[];aW=aV.toObject();for(aU in aW){aX=aW[aU];if(aU[0]!=="_"){aT.push(aX)}}aQ+=aT.join(",");return aQ+="\r\n"});aO.setHeader("Content-Type","text/csv");return aO.send(aQ)})});ag={checkAuth:["list","get","put","delete"],query:w.find().sort("-createdAt")};l(F,w,ag,function(aQ,aR){var aP,aO;if(aQ==="post"){ao.get("data notify")("subscriptions","Подписки",aR);aP=ao.get("unisender key");if(!aP){return}aO=new h(aP);aO.subscribe(aR.email)}if(aQ==="get"&&!aR.viewed){aR.viewed=true;return aR.save()}});R();U=ao.get("connection");v=ao.get("mongoose");F=ao.get("app");x=new v.Schema({name:{type:"string",required:true},createdAt:{type:Date,"default":Date.now}});aD=U.model("towns",x);l(F,aD,{query:aD.find()},function(aO,aP){if(aO==="post"){return ao.get("data notify")("towns","Новый город",aP)}});return R()}}).call(this);